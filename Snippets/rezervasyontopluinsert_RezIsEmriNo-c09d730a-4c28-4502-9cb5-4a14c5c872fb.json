{
  "id": "c09d730a-4c28-4502-9cb5-4a14c5c872fb",
  "prefix": "rezervasyontopluinsert_RezIsEmriNo",
  "description": "",
  "body": "--toplu insert\nDeclare @IsRezervasyonYapilir int,@RezervTipID int,@StokTipID int,@StokRezervID int,@Mt TinyInt,@Kg TinyInt, @Ad TinyInt,\n/*Cursor Varibales*/ @cPlanMakinaID int, @cPlanMiktar Decimal(28,6), @cIsEmriNo int,\n/*Sub Cursor Variables*/ @SubcRezervasyonMiktar_Kg Decimal(28,6),@SubcRezervasyonMiktar_Mt decimal(28,6)  , @SubcRezervasyonMiktar_Ad int  ,@TuketimMiktar_Mt Decimal(28,6) ,@TuketimMiktar_Kg Decimal(28,6),  @TuketimMiktar_Ad int, @SubCAmbarID int,@SubCUrunTID int,@SubCUrunID int,@SubCPlanMakinaGirenID int,@SubCRezIsEmriNo int\n\n\n\tDeclare c Cursor Local For\n\tSelect PM.PlanMakinaID, (PM.Miktar_Kg-PM.UrtKg) PlanMiktar ,PRD.IsEmriNo\n\tFrom   IT05_PlanMakina PM\n\t             Inner Join IT05_PartiRotaD PRD ON PM.PlanID = PRD.PlanID\n\tWhere  PRD.ProsesID = 2 And PM.IsNoZamanDurum in (1,-1)  --30 için yapıldı 25 için yaplıacak\n\n\n\n\t\t \t  \n\t \t--Select\t \n\t\t --CASE ISNULL(SD.AnaOlcuBirimID, S.AnaOlcuBirimID) \n\t \t--\t\t\t\t\t\tWHEN 1 THEN ISNULL(PRD.PlanMt,0)-ISNULL(PRD.UrtMt,0) \n\t \t--\t\t\t\t\t\tWHEN 2 THEN ISNULL(PRD.PlanKg,0)-ISNULL(PRD.UrtKg,0) \n\t \t--\t\t\t\t\t\tWHEN 3 THEN ISNULL(PRD.PlanAd,0)-ISNULL(PRD.UrtAd,0) \n\t \t--\t\t\t\t\t\tELSE 0 End PlanMiktar,\n\n\t\t\t--\t\t\t\t    PRM.IsEmriNo,\n\t\t\t\t\t\t\t\t\n\t\t\t--\t\t\t\t\tPRD.ProsesID,S.AnaOlcuBirimID\n\t \t--From\tIT05_PartiRotaD PRD \n\t \t--\t\tINNER JOIN IT05_PartiRotaM PRM ON PRD.IsEmriNo = PRM.IsEmriNo \n\t \t--\t\tINNER JOIN IT04_SiparisD SD  ON PRM.SiparisDetayID = SD.SiparisDetayID \n\t \t--\t\tINNER JOIN IT06_Stoklar S ON SD.UrunTID = S.UrunTID\n\t\t\t--\tWhere PRD.UrunDonusumu =1 \n--AnaOlcuBirimID\tAnaOlcuBirimAdi\n--1\tMETRE\n--2\tKİLO\n--3\tADET\n\n--ProsesID\tAnaOlcuBirimID \n--4\t\t\t\t\t2 KİLO\n--3\t\t\t\t\t2 KİLO\n--1\t\t\t\t\t2 KİLO\n--30\t\t\t\t1 METRE\n--55\t\t\t\t2 KİLO\n--5\t\t\t\t\t2 KİLO\n--9\t\t\t\t\t2 KİLO\n--25\t\t\t\t1 METRE\n--21\t\t\t\t2 KİLO\n--2\t\t\t\t\t2 KİLO\n\n\t\t\n\n\tOpen c\n\tFetch Next From c\n\tInto @cPlanMakinaID, @cPlanMiktar,@cIsEmriNo\n\tWhile @@FETCH_STATUS = 0 Begin\n\t\n\t\tSelect\t @IsRezervasyonYapilir = ISNULL(IET.IsRezervasyonYapilir,0)\n\t\t\t\t\tFrom\tIT05_PartiRotaM PRM\n\t\t\t\t\t\t\tInner Join IT01_IsEmriTipleri IET On PRM.IsEmriTipID = IET.IsEmriTipID \n\t\t\t\t\tWhere\tPRM.IsEmriNo = @cIsEmriNo \n\t\n\t\tIf @IsRezervasyonYapilir  = 1  Begin \n\t\n\t\n\t\t\tDeclare SubC Cursor Local For\n\t\t\n\t\t\tSelect  ISNULL(@cPlanMiktar*TuketimBirim_Kg,0) As RezervasyonMiktar_Kg, ISNULL(@cPlanMiktar*TuketimBirim_Mt,0) As RezervasyonMiktar_Mt, ISNULL(@cPlanMiktar*TuketimBirim_Ad,0) As RezervasyonMiktar_Ad, AmbarID, UrunTID,UrunID,PlanMakinaGirenID,IsEmriNo\n\t\t\tFrom   IT05_PlanMakina_Giren \n\t\t\tWhere  PlanMakinaID = @cPlanMakinaID\n\t\t\n\t\t\tOpen SubC\n\t\t\tFetch Next From SubC Into @SubcRezervasyonMiktar_Kg,@SubcRezervasyonMiktar_Mt, @SubcRezervasyonMiktar_Ad, @SubCAmbarID,@SubCUrunTID,@SubCUrunID,@SubCPlanMakinaGirenID ,@SubCRezIsEmriNo\n\t\t\tWhile @@FETCH_STATUS = 0 Begin\n\t\n\t\t\t\t\t\t\tSelect\t@StokTipID = S.StokTipID, @Mt = ISNULL(ST.Mt,0), @Kg = ISNULL(ST.Kg,0), @Ad = ISNULL(ST.Ad,0)\n\t \t\t\t\t\t\tFrom\tIT06_Stoklar S \n\t \t\t\t\t\t\t\t\tINNER JOIN IT01_StokTipleri ST ON S.StokTipID = ST.StokTipID\n\t \t\t\t\t\t\tWhere\tS.UrunTID = @SubCUrunTID \n\n\t\t\t\t\t\t\tSet @RezervTipID = (Select RezervTipID From IT15_RezervTipleri Where StokTipID = @StokTipID And AmbarID = @SubCAmbarID)\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tIf @RezervTipID Is Not Null Begin \n\n\t\t\t\t\t\t\t\tSet @TuketimMiktar_Mt = ISNULL(@SubcRezervasyonMiktar_Mt,0)*@Mt\n\t \t\t\t\t\t\t\tSet @TuketimMiktar_Kg = ISNULL(@SubcRezervasyonMiktar_Kg,0)*@Kg\n\t \t\t\t\t\t\t\tSet @TuketimMiktar_Ad = ISNULL(@SubcRezervasyonMiktar_Ad,0)*@Ad\n\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tExec SP06_StokRezervasyon_Ham @RezervTipID = @RezervTipID, @AmbarID = @SubCAmbarID, @UrunTID = @SubCUrunTID, @UrunID = @SubCUrunID, @IsEmriNo = null, --IsEmriNo NULL gidecek\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t @Miktar_Mt = @TuketimMiktar_Mt,  @Miktar_Kg = @TuketimMiktar_Kg, @Miktar_Ad = @TuketimMiktar_Ad, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t @StokRezervID = @StokRezervID Output\n\t\t\n\t\t\n\t\t\t\t\t\t\t\t Update IT05_PlanMakina_Giren Set TuketimMiktar_Kg = @TuketimMiktar_Kg, TuketimMiktar_Mt  =@TuketimMiktar_Mt, TuketimMiktar_Ad = @TuketimMiktar_Ad, IsITUpdate = IsITUpdate\n\t\t\t\t\t\t\t\t Where  PlanMakinaGirenID = @SubCPlanMakinaGirenID\n\n\t\t\t\t\t\t\t\t \tIf Not Exists (SELECT * FROM  IT05_PlanMakina_Giren PMG Where PMG.StokRezervID = @StokRezervID)  begin\n\t\t\t\t\t\t\t\t\t\tUpdate IT05_PlanMakina_Giren Set StokRezervID  = @StokRezervID,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t IsITUpdate = IsITUpdate\n\t\t\t\t\t\t\t\t\t\tWhere\tPlanMakinaGirenID = @SubCPlanMakinaGirenID\n\t\t\t\t\t\t\t\t\tEND\n\n\t\t\t\t\t\t\t END\n\t\t\n\t\t\tFetch Next From SubC Into @SubcRezervasyonMiktar_Kg,@SubcRezervasyonMiktar_Mt, @SubcRezervasyonMiktar_Ad,@SubCAmbarID,@SubCUrunTID,@SubCUrunID,@SubCPlanMakinaGirenID,@SubCRezIsEmriNo\n\t\t\tEnd\n\t\t\tClose SubC\n\t\t\tDeallocate SubC\n\t\t\n\t\tEnd\n\t\t\n\tFetch Next From c Into @cPlanMakinaID, @cPlanMiktar,@cIsEmriNo\n\tEnd\n\tClose c\n\tDeallocate c\n\n\n\n\n\n\n"
}