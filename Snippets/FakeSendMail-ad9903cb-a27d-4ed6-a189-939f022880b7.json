{
  "id": "ad9903cb-a27d-4ed6-a189-939f022880b7",
  "prefix": "FakeSendMail",
  "description": "bu şablona göre sendmail proc larını yazarız.",
  "body": "Create PROCEDURE  SP15_SendMail_TedarikciPuanlamaFirma\n\nAS\nSET NOCOUNT ON\nBEGIN \n\tBEGIN TRY \n\t\n\tDECLARE  @ITMailServerName varchar(100), @ITMailAccountName varchar(100), @PersonelMailAdress varchar(5000) , @Subject varchar(5000), @rc int,\n\t\t     @MsjText varchar (5000), @YText varchar (8000),@Aciklama varchar (8000),@GecikenFirmalar varchar (8000), @SubjectText varchar (1000),@K int, @h int\n\t\n\tDECLARE @TmpPuan Table (ID Int IDENTITY(1,1) NOT NULL,\n\t                        Ay int ,\n                            Yil int,\n                            SipFirmaKodu varchar (40),\n                            HamKod varchar(50),ZamanPuani decimal(18,2),\n                            MiktarPuani decimal(18,2), KalitePuani decimal(18,2)) \n\n  \n     SELECT @ITMailServerName = ITMailServerName , @ITMailAccountName = ITMailAccountName FROM IT15_System  \n      \n     INSERT  @TmpPuan (Ay,Yil,SipFirmaKodu,HamKod,ZamanPuani,MiktarPuani,KalitePuani) \n       \n     SELECT TP.Ay, TP.Yil, TP.SipFirmaKodu,TP.HamKod, \n            AVG(TP.ZamanPuani) AS ZamanPuani,   \n            AVG(TP.MiktarPuani) AS MiktarPuani,\n            AVG(TP.KalitePuani) AS KalitePuani\n       \n            FROM BOY2_TedarikciPuanlama TP\n            WHERE TP.AY=Datepart(month,Getdate()-27)  AND TP.Yil=(CASE WHEN Datepart(month,Getdate()-27) = 12\n                                                                       THEN  Datepart(year,Getdate())-1\n                                                                       ELSE  Datepart(year,Getdate())\n                                                                        END) \n                                                  --AND TP.HamUrunTID IN (153,46169,155,4962)\n            GROUP BY TP.Ay, TP.Yil, TP.SipFirmaKodu,TP.HamKod\n      \n      SET @K= ((select COUNT (SipFirmaKodu) from  @TmpPuan ) /40)+1\n      \n      SET @h=0\n     \n      WHILE @h<@K \n      BEGIN  \n      \n         SET @SubjectText = 'AYLIK TEDARİKÇİ PUANLARI ' + ' (Sayfa :' + Convert(Varchar(2),@H+1) + ' )'\n      \n      \n         SET @GecikenFirmalar = 'YIL<td bgcolor=\"#9999FF\">AY</td><td bgcolor=\"#9999FF\">FİRMA</td><td bgcolor=\"#9999FF\">URUN KODU</td><td bgcolor=\"#9999FF\">ZAMAN PUAN</td><td bgcolor=\"#9999FF\">MİKTAR PUAN</td><td bgcolor=\"#9999FF\">KALİTE PUAN</td>'\n\t  \n\t     SELECT @GecikenFirmalar= @GecikenFirmalar+'<tr><td>'+ CONVERT (varchar,(TP.Yil))+'</td><td>'+CONVERT (varchar,(TP.Ay))\n\t\t\t\t\t\t\t+'</td><td>'+TP.SipFirmaKodu+'</td><td>'+TP.HamKod+'</td><td>'\n\t\t\t\t\t\t\t+ CONVERT (varchar,ROUND(CAST((ZamanPuani)as int),0),1)+'</td><td>'+CONVERT (varchar,ROUND(CAST((MiktarPuani)as int),0),0)+'</td><td>'+replace(replace(CONVERT (varchar,ROUND(CAST((KalitePuani)as int),0),1),'',''),',',',')+'</td></tr>'\n\t\n         FROM @TmpPuan TP\n         WHERE ID between @H*40 AND @H*40+41\n         GROUP BY ID,TP.Ay, TP.Yil, TP.SipFirmaKodu,TP.ZamanPuani,TP.MiktarPuani,TP.KalitePuani,TP.HamKod\n\n\t   \n\t      SET @Aciklama = ' '\n\t      SET @Aciklama = @Aciklama+'Sn.İlgililer,<BR><BR> Geçen Ay Tedarikçilerin Değerlendirme Puanları aşağıdaki gibidir...'+'<BR><hr width=\"140%\" color=\"#0000F8\" size=\"1\">'\n\t       + '<BR><BR><table border=\"1\" bgcolor=\"#00000\">\n\t       <tr>\n\t\t   <td bgcolor=\"#9999FF\">' \n              +@GecikenFirmalar+\n             '</td></tr></table>'\n     \n       \n       SET @YText=@Aciklama\n      \n\t\n\t   EXEC @rc = msdb.dbo.sp_send_dbmail \n\t   \n\t   @profile_name = 'ITTEXTILE', \n\t   @recipients ='Zuhal.Alpaslan@boyteks.com',\n\t   @subject = @SubjectText, \n\t   @body = @YText,\n\t   @body_format = 'HTML'\n\t   \n\t   set @h=@h+1\n\t  \n\t   END\n\t   \n\t    END TRY \n\t    BEGIN CATCH\t\n\t\tDeclare @ITObjectName nvarchar(126)\n\t\tSet @ITObjectName = OBJECT_NAME (@@PROCID)\n\t\tExecute SP15_GenerateError @ITObjectName\n\t\n\t   END CATCH\n  END\n     \n\nGO\n"
}