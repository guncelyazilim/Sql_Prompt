{
  "id": "0c398248-8da1-453d-8463-aff764e3dc48",
  "prefix": "snp_ObjectsD_Aktarma_V3",
  "description": "veri işlem aktarımı eklendi",
  "body": "/*\nİşlevi : ObjectsD ayarlarını script olarak alıp aktarmaya yarar\nKullanımı : \n\t1. Aşağıdaki Scriptte @Objects tablosuna hangi nesnelerin aktarılacağı yazılır ve \"Kaynak\" Veri Tabanında çalıştırılır. \n\t2. \n\t3. Oluşan script hedef veri tabanında çalıştırılır.\n\n\nDİKKAT: Scipt almadan önce aşağıdaki ayarları yapın \n\t1. Results To text yap\n\t2. \"SSMS > Options > Query Results > SQL Server\" sayfasındaki \"Maximum number of characters displayed in each column\" alanınnı 20.000 gibi büyük bir sayı verin.\n*/\n\nSet NoCount On\n\nDeclare @KolonlariAktar TinyInt, @VeriIslemleriniAktar TinyInt\nDeclare @Objects Table(ITObjectName Varchar(100))\n\n/*********** BEGIN INPUT ************/\nInsert @Objects (ITObjectName) \nValues \n('$CURSOR$')\n\nSet @KolonlariAktar = 1\nSet @VeriIslemleriniAktar = 1\n\n/*********** END INPUT ************/\n\n\n/*  1. Tanımlamalar */\nPrint 'Set NoCount On '\nPrint 'Set Ansi_Null_Dflt_On On'\n\nPrint 'If Object_Id(''tempdb..#Alanlar'') Is Not Null Drop Table #Alanlar\t\nCreate Table #Alanlar(ITObjectName varchar(100), FieldName Varchar(40), FieldCaption Varchar(40), ShowSiraNo int, CaptionSize int, Type tinyint, NotInGrid tinyint, ITRequired tinyint, LField tinyint, LDataSet varchar(50), LKeyFields varchar(50), LLKeyFields varchar(50), LResultField varchar(50), LWhereText varchar(500), LOrderText varchar(500), LDetailDataSet varchar(50) , ITReadOnly TinyInt, ITVisible  TinyInt, ITDefValue Varchar(100) )'\n\nPrint 'If OBJECT_ID(''tempdb..#VeriIslemleri'') Is Not Null Drop Table #VeriIslemleri \nCreate Table #VeriIslemleri (ITobjectName Varchar(100),SiraNo Smallint,VeriIslemAdi Varchar(50),SPITObjectName Varchar(100),DSITObjectName Varchar(100),DSITObjectID2Name Varchar(100),SFilterFieldName Varchar(50),DFilterFieldName Varchar(50),IsOnay tinyint,IsBeginGroup tinyint,SPITObjectIDWhereText Varchar(200),DSITWhereText Varchar(200),DS2ITWhereText Varchar(200),ITShortCutName Varchar(100),AnalizDataName Varchar(100),ITObjectItemGroupName Varchar(100),IsDSRequery tinyint,ShowInTab tinyint,IsToolbarButton tinyint) '\n\nIf @KolonlariAktar = 1 Begin\n\t/* 2.A Alanlar Kaydedilir. */\n\tSelect  Concat('Insert #Alanlar (ITObjectName, FieldName, FieldCaption, ShowSiraNo, CaptionSize, Type, NotInGrid, ITRequired, LField, LDataSet, LKeyFields, LLKeyFields, LResultField, LWhereText, LOrderText, LDetailDataSet, ITReadOnly, ITVisible, ITDefValue)'+ CHAR(13) +\n\t\t\t' VALUES(''',OM.ITObjectName, ''',''', OD.FieldName, ''', ''', FieldCaption, ''', ', OD.ShowSiraNo, ', ', ISNULL(OD.CaptionSize,7), ', ', OD.Type, ', ', IsNull(OD.NotInGrid, 0), ', ', IsNull(OD.ITRequired, 0), ', ', \n\t\t\t ISNULL(OD.LField,0), ',''', OD.LDataSet, ''',''', OD.LKeyFields, ''',''', OD.LLKeyFields, ''',''', OD.LResultField, ''',''', OD.LWhereText, ''',''', OD.LOrderText, ''',''', OD.LDetailDataSet, ''', ',\n\t\t\t ISNULL(ROD.ITReadOnly,0) , ', ', ISNULL(ROD.ITVisible,0) , ', ''', ROD.ITDefValue, ''')')\n\tFrom\tIT15_ObjectsD OD \n\t\t\tInner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n\t\t\tLEFT OUTER JOIN IT15_RolObjectsM ROM On ROM.ITObjectID = OM.ITObjectID And ROM.RolID = 1 /* Güncel Rolünün Yetkileri alınır */\n\t\t\tLEFT OUTER JOIN IT15_RolObjectsD ROD On ROD.RolObjectMID = ROM.RolObjectMID And ROD.ITObjectDID = OD.ITObjectDID\n\tWhere\tOM.ITObjectName in (Select O.ITObjectName From @Objects O)\n\n\n\t/* 2.X */\n\tPrint '\n\t\n\tDeclare @name Varchar(100)\n\tDeclare c Cursor Local For\n\t\tSelect Distinct ITObjectName From #Alanlar\n\tOpen c\n\tFetch Next From c Into @name\n\tWhile @@FETCH_STATUS = 0 Begin\n\t\n\t\tExec SP15_AlanYenile @name\n\n\t\tFetch Next From c Into @name\n\tEnd\n\tClose c\n\tDeallocate c\n\n\t'\n\n\n\t/*2.B.1 Alanlar aktarılır - var olanlar güncellenir (yeni normal kolon hiçbir zaman eklenmez.) */\n\tPrint '\n\tDeclare @Adet int\n\n\tUpdate\tOD Set \n\t\t\tFieldCaption = A.FieldCaption, \n\t\t\tShowSiraNo = A.ShowSiraNo, \n\t\t\tCaptionSize = A.CaptionSize, \n\t\t\tType = A.Type,\n\t\t\tNotInGrid = A.NotInGrid,\n\t\t\tITRequired = A.ITRequired,\n\t\t\tLField = A.LField, \n\t\t\tLDataSet = A.LDataSet, \n\t\t\tLKeyFields = A.LKeyFields, \n\t\t\tLLKeyFields = A.LLKeyFields, \n\t\t\tLResultField = A.LResultField, \n\t\t\tLWhereText = A.LWhereText, \n\t\t\tLOrderText = A.LOrderText, \n\t\t\tLDetailDataSet = A.LDetailDataSet\n\tFrom\tIT15_ObjectsD OD \n\t\t\tInner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n\t\t\tInner Join #Alanlar A On OD.FieldName = A.FieldName COLLATE DATABASE_DEFAULT  And A.ITObjectName = OM.ITObjectName COLLATE DATABASE_DEFAULT \n\n\n\tSet @Adet = @@ROWCOUNT\n\n\tIf @Adet = 0 Raiserror(''Hiç Güncelleme yapılmadı. Muhtemelen bir yanlışlık var.'',16,1)\n\tElse Print Convert(varchar(10), @Adet) +  '' adet satır güncellendi.''\n\n\t'\n\n\n\n\t/*\t2.B.2 Alanlar aktarılır - LOOK-UP kolonlar eklenir, yetkisi verilir. */\n\tPrint '\n\tInsert IT15_ObjectsD (ITObjectID, FieldName, FieldCaption, ShowSiraNo, CaptionSize, Type, NotInGrid, ITRequired, LField, LDataSet, LKeyFields, LLKeyFields, LResultField,\n\t\t   LWhereText, LOrderText, LDetailDataSet, FieldType)\n\n\tSELECT\tOM.ITObjectID, A.FieldName, A.FieldCaption, A.ShowSiraNo, A.CaptionSize, A.Type, A.NotInGrid, A.ITRequired, A.LField, A.LDataSet, A.LKeyFields,\n\t\t\tA.LLKeyFields, A.LResultField, A.LWhereText, A.LOrderText, A.LDetailDataSet, ''varchar''\n\tFrom\t#Alanlar A\n\t\t\tINNER JOIN IT15_ObjectsM OM On OM.ITObjectName = A.ITObjectName Collate Database_Default\n\n\tWhere\tISNULL(A.LDataSet,'''') <> ''''\n\t\t\tAnd Not Exists(\n\t\t\t\tSELECT * FROM IT15_ObjectsD OD Where OD.ITObjectID = OM.ITObjectID And OD.LDataSet = A.LDataSet Collate Database_Default \n\t\t\t\tAnd OD.LKeyFields = A.LKeyFields Collate Database_Default And OD.LLKeyFields = A.LLKeyFields Collate Database_Default And OD.LResultField = A.LResultField Collate Database_Default\n\t\t\t)\n\n\tSet @Adet = @@ROWCOUNT\n\n\tIf @Adet > 0 Begin\t\n\t\tPrint ''     '' + convert(varchar(10), @Adet) + '' adet yeni lookup kolon yaratıldı. Tövbe.. oluştuldu.''\n\n\t\t/*  Eğer yeni kolon eklendiyse yetkisi de verilir. */\n\t\tInsert  IT15_RolObjectsD(RolObjectMID, ITObjectDID, ITReadOnly, ITVisible, ITDefValue)\n\t\tSelect  ROM.RolObjectMID, OD.ITObjectDID, A.ITReadOnly, A.ITVisible, A.ITDefValue\n\t\tFrom    IT15_ObjectsD OD\n\t\t\t\tInner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n\t\t\t\tInner Join #Alanlar A On A.ITObjectName = OM.ITObjectName Collate Database_Default And A.FieldName = OD.FieldName Collate Database_Default\n\t\t\t\tInner Join IT15_RolObjectsM ROM On ROM.ITObjectID = OM.ITObjectID And  ROM.RolID = 1\n\t\tWhere   Not Exists (Select  * From  IT15_RolObjectsD ROD Where  ROD.RolObjectMID = ROM.RolObjectMID And ROD.ITObjectDID = OD.ITObjectDID)\n\t\n\t\tSet @Adet = @@ROWCOUNT\n\n\t\tPrint ''     '' + Convert(varchar(10), @Adet) + '' adet yeni lookup için yetki verildi.''\n\n\tEnd\n\t'\n\n\t/* 2.B.3 Tüm kolon yetkileri güncellenir. (sadece güncel rolü için) */\n\n\tPrint '\n\n\tUpdate  ROD\n\tSet     ROD.ITReadOnly = A.ITReadOnly, ROD.ITVisible = A.ITVisible, ROD.ITDefValue = A.ITDefValue\n\tFrom    IT15_ObjectsD OD\n\t\t\tInner Join IT15_RolObjectsD ROD On OD.ITObjectDID = ROD.ITObjectDID\n\t\t\tInner Join IT15_RolObjectsM ROM On ROD.RolObjectMID = ROM.RolObjectMID And ROM.RolID = 1 /* Sadece GUNCEL */\n\t\t\tInner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n\n\t\t\tInner Join #Alanlar A On OD.FieldName = A.FieldName COLLATE DATABASE_DEFAULT  And A.ITObjectName = OM.ITObjectName COLLATE DATABASE_DEFAULT\n\n\n\tSet @Adet = @@ROWCOUNT\n\n\tIf @Adet = 0 Raiserror(''Yetkilerde hiç güncelleme yapılmadı. Muhtemelen bir GUNCEL In yetkisi yok. Veya daha kötü birşeyler...'',16,1)\n\tElse Print Convert(varchar(10), @Adet) + '' adet satır kolon yetkisi güncellendi.''\n\n\n\t'\n\nEnd \n\n\n\nIf @VeriIslemleriniAktar = 1 Begin\n\t/* 3.A Veri işlemleri kaydedilir. */\n\tSelect\n\tConcat('Insert #VeriIslemleri (ITobjectName, SiraNo, VeriIslemAdi, SPITObjectName, DSITObjectName, DSITObjectID2Name, SFilterFieldName, DFilterFieldName, IsOnay, IsBeginGroup, SPITObjectIDWhereText, DSITWhereText, DS2ITWhereText, ITShortCutName, AnalizDataName, ITObjectItemGroupName, IsDSRequery, ShowInTab, IsToolbarButton)' + CHAR(13) +\n\t\t\t'Values( ''', OM.ITobjectName, ''', ', ISNULL(SiraNo, 0),  ',''', VeriIslemAdi, ''', ''', SPOM.ITObjectName, ''', ''', DSOM.ITObjectName, ''', ''', DSOM2.ITObjectName, ''', ''', SFilterFieldName, ''', ''', DFilterFieldName, ''', ', ISNULL(IsOnay,0), ', ', ISNULL(IsBeginGroup,0), ', ''', SPITObjectIDWhereText, ''', ''', DSITWhereText, ''', ''', DS2ITWhereText, ''', ''', ISC.ITShortcut, ''', ''', ADM.AnalizAdi, ''', ''', G.ItemGroupName, ''', ', ISNULL(IsDSRequery, 0), ', ', ISNULL(ShowInTab,0), ', ', ISNULL(IsToolbarButton,0), ')')\n\tFrom\tIT15_ObjectsVeriIslemleri VI\n\t\t\tLeft Outer Join IT15_ObjectsM OM On\tOM.ITObjectID = VI.ITobjectID\n\t\t\tLeft Outer Join IT15_ObjectsM SPOM On SPOM.ITObjectID = VI.SPITObjectID\n\t\t\tLeft Outer Join IT15_ObjectsM DSOM On DSOM.ITObjectID = VI.DSITObjectID\n\t\t\tLeft Outer Join IT15_ObjectsM DSOM2 On DSOM2.ITObjectID = VI.DSITObjectID2\n\t\t\tLeft Outer Join IT15_ITShortCuts ISC On ISC.ITShortcutID = VI.ITShortCutID\n\t\t\tLeft Outer Join IT15_AnalizDataM ADM On ADM.AnalizDataID = VI.AnalizDataID\n\t\t\tLeft Outer Join IT15_ObjectsItemGroup G On G.ITObjectItemGroupID = VI.ITObjectItemGroupID\n\tWhere\tOM.ITObjectName in (Select O.ITObjectName From @Objects O)\n\n\t\n\n\t/* 3.B Veri işlemleri aktarılır */\n\tPrint '\n\tInsert  IT15_ObjectsItemGroup (ITObjectID, ItemGroupType, ItemGroupName)\n\tSelect  Distinct OM.ITObjectID, 2, VI.ITObjectItemGroupName\n\tFrom    #VeriIslemleri VI\n\t\t\tInner Join IT15_ObjectsM OM On OM.ITObjectName = VI.ITobjectName Collate Database_Default\n\tWhere   VI.ITObjectItemGroupName Is Not Null\n\t\t\tAnd not exists(select * from IT15_ObjectsItemGroup T Where T.ITObjectID = OM.ITObjectID And T.ItemGroupName = VI.ITObjectItemGroupName Collate Database_Default And T.ItemGroupType = 2 )\n\n\tInsert  IT15_ObjectsVeriIslemleri (ITObjectID, SiraNo, VeriIslemAdi, SPITObjectID, DSITObjectID, DSITObjectID2, SFilterFieldName, DFilterFieldName, IsOnay, IsBeginGroup, SPITObjectIDWhereText, DSITWhereText, DS2ITWhereText, ITShortCutID, AnalizDataID, ITObjectItemGroupID, IsDSRequery, ShowInTab, IsToolbarButton)\n\tSelect  OM.ITObjectID, VI.SiraNo, VI.VeriIslemAdi, SPOM.ITObjectID, DSOM.ITObjectID, DSOM2.ITObjectID, VI.SFilterFieldName, VI.DFilterFieldName, VI.IsOnay, VI.IsBeginGroup, VI.SPITObjectIDWhereText, VI.DSITWhereText, VI.DS2ITWhereText, ISC.ITShortcutID, ADM.AnalizDataID, G.ITObjectItemGroupID, VI.IsDSRequery, VI.ShowInTab, VI.IsToolbarButton\n\tFrom    #VeriIslemleri VI\n\t\t\tLeft Outer Join IT15_ObjectsM OM On OM.ITObjectName = VI.ITobjectName Collate Database_Default\n\t\t\tLeft Outer Join IT15_ObjectsM SPOM On SPOM.ITObjectName = VI.SPITObjectName Collate Database_Default\n\t\t\tLeft Outer Join IT15_ObjectsM DSOM On DSOM.ITObjectName = VI.DSITObjectName Collate Database_Default\n\t\t\tLeft Outer Join IT15_ObjectsM DSOM2 On DSOM2.ITObjectName = VI.DSITObjectID2Name Collate Database_Default\n\t\t\tLeft Outer Join IT15_ITShortCuts ISC On ISC.ITShortcut = VI.ITShortCutName Collate Database_Default\n\t\t\tLeft Outer Join IT15_AnalizDataM ADM On ADM.AnalizAdi = VI.AnalizDataName Collate Database_Default\n\t\t\tLeft Outer Join IT15_ObjectsItemGroup G On G.ITObjectID = OM.ITObjectID And G.ItemGroupName = VI.ITObjectItemGroupName Collate Database_Default\n\tWhere Not Exists(Select * From IT15_ObjectsVeriIslemleri OVI Where OVI.ITObjectID = OM.ITObjectID And OVI.VeriIslemAdi = VI.VeriIslemAdi Collate Database_Default)\n\t\t\tAnd (\n\t\t\t\tNot(ISNULL(VI.SPITObjectName,'''') <> '''' And SPOM.ITObjectID Is Null)\n\t\t\t\tAnd\n\t\t\t\tNot(ISNULL(VI.DSITObjectName,'''') <> '''' And DSOM.ITObjectID Is Null )\n\t\t\t\tAnd\n\t\t\t\tNot(ISNULL(VI.DSITObjectID2Name,'''') <> '''' And DSOM2.ITObjectID Is Null )\n\t\t\t)\n\n\n\tSet @Adet = @@ROWCOUNT\n\n\n\tIf @Adet = 0 Raiserror(''Hiç veri işlemi eklenmedi. '',16,1)\n\tElse Begin\n\t\tDeclare @ToplamAdet int = (Select COUNT(*) From #VeriIslemleri VI)\n\t\tPrint Convert(varchar(10), @Adet) + '' adet veri işlemi eklendi. Toplam veri işlem adedi : '' + Convert(varchar(10),  @ToplamAdet ) \n\tEnd \n\n\tDeclare @M varchar(1000)\n\tSelect\t@M = ISNULL(@M + '','', '''') +  H.N\n\tFrom\t#VeriIslemleri V Cross Apply (Select V.SPITObjectName As N Union Select V.DSITObjectName Union Select V.DSITObjectID2Name ) H\n\tWhere Not Exists(Select * From IT15_ObjectsM OM Where OM.ITObjectName = H.N Collate Database_Default) And  ISNULL(H.N,'''') <> ''''\n\tIf @M Is Not Null Raiserror(''Şu nesneler olmadığı için veri işlemleri eklenemedi. '',16,1, @M)\n\n\n\t'\nEnd\n\n\n\n\n\n"
}