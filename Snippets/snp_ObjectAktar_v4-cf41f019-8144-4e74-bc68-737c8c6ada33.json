{
  "id": "cf41f019-8144-4e74-bc68-737c8c6ada33",
  "prefix": "snp_ObjectAktar_v4",
  "description": "",
  "body": "/*\nİşlevi : ObjectsD ayarlarını script olarak alıp aktarmaya yarar\n\n \n\nKullanımı : \n    1. Aşağıdaki Scriptte @Objects tablosuna hangi nesnelerin aktarılacağı yazılır ve \"Kaynak\" Veri Tabanında çalıştırılır.\n    2. Oluşan script hedef veri tabanında çalıştırılır.\n\nAyarlar : \n    DİKKAT: Scipt almadan önce aşağıdaki ayarları yapın :\n        1. Results To text yap\n        2. \"SSMS > Options > Query Results > SQL Server\" sayfasındaki \"Maximum number of characters displayed in each column\" alanınnı 20.000 gibi büyük bir sayı verin.\n\nDiğer Seçenekler : \n    1. @KolonlariAktar : Aşağıdaki ayaları aktarır\n        * Kolon Ayarları (lookup kolonlar da oluşuturulur)\n        * Güncel için Kolon Yetkileri\n        * Güncel için Nesne yetkisi \n    2. @VeriIslemleriniAktar \n        * Veri işlemleri aktarılır. Aktarım yapılabilmesi için veri nesnesinin hedef veri tabanında olması gerekir.\n\n*/\n\n \n\nSet NoCount On\n\n \n\nDeclare @KolonlariAktar TinyInt, @VeriIslemleriniAktar TinyInt\nDeclare @Objects Table(ITObjectName Varchar(100))\n\n \n\n/*********** BEGIN INPUT ************/\nInsert @Objects (ITObjectName) \nValues \n('IT15_ButtonPositions')\n\n \n\nSet @KolonlariAktar = 1\nSet @VeriIslemleriniAktar = 1\n\n \n\n/*********** END INPUT ************/\n\n \n\n \n\n/*  1. Tanımlamalar */\nPrint 'Set NoCount On '\nPrint 'Set Ansi_Null_Dflt_On On'\n\n \n\nPrint 'If Object_Id(''tempdb..#Alanlar'') Is Not Null Drop Table #Alanlar    \nCreate Table #Alanlar(ITObjectName varchar(100), FieldName Varchar(40), FieldCaption Varchar(40), ShowSiraNo int, CaptionSize int, Type tinyint, NotInGrid tinyint, ITRequired tinyint, LField tinyint, LDataSet varchar(50), LKeyFields varchar(50), LLKeyFields varchar(50), LResultField varchar(50), LWhereText varchar(500), LOrderText varchar(500), LDetailDataSet varchar(50) , ITReadOnly TinyInt, ITVisible  TinyInt, ITDefValue Varchar(100), ITObjectItemGroupName Varchar(100), ROMITEdit tinyint, ROMITInsert tinyint, ROMITDelete tinyint, ROMITReadOnly tinyint)'\n\n \n\nPrint 'If OBJECT_ID(''tempdb..#VeriIslemleri'') Is Not Null Drop Table #VeriIslemleri \nCreate Table #VeriIslemleri (ITobjectName Varchar(100),SiraNo Smallint,VeriIslemAdi Varchar(50),SPITObjectName Varchar(100),DSITObjectName Varchar(100),DSITObjectID2Name Varchar(100),SFilterFieldName Varchar(50),DFilterFieldName Varchar(50),IsOnay tinyint,IsBeginGroup tinyint,SPITObjectIDWhereText Varchar(200),DSITWhereText Varchar(200),DS2ITWhereText Varchar(200),ITShortCutName Varchar(100),AnalizDataName Varchar(100),ITObjectItemGroupName Varchar(100),IsDSRequery tinyint,ShowInTab tinyint,IsToolbarButton tinyint) '\n\n \n\nIf @KolonlariAktar = 1 Begin\n    /* 2.A Alanlar Kaydedilir. */\n    Select  'Insert #Alanlar (ITObjectName, FieldName, FieldCaption, ShowSiraNo, CaptionSize, Type, NotInGrid, ITRequired, LField, LDataSet, LKeyFields, LLKeyFields, LResultField, LWhereText, LOrderText, LDetailDataSet, ITReadOnly, ITVisible, ITDefValue, ITObjectItemGroupName, ROMITEdit, ROMITInsert, ROMITDelete, ROMITReadOnly)' + CHAR(13) +\n            ' VALUES(''' + OM.ITObjectName + ''',''' + OD.FieldName + ''', ''' + FieldCaption + ''', ' + CONVERT(VARCHAR(100), OD.ShowSiraNo) + ', ' + CONVERT(VARCHAR(100), ISNULL(OD.CaptionSize,7)) + ', '\n            + CONVERT(VARCHAR(100), OD.Type)+ ', '+ CONVERT(VARCHAR(100), IsNull(OD.NotInGrid, 0)) + ', '+ CONVERT(VARCHAR(100), IsNull(OD.ITRequired, 0)) + ', '\n            + CONVERT(VARCHAR(100), ISNULL(OD.LField,0))+ ','''+ ISNULL(OD.LDataSet, '')+ ''','''+ ISNULL(OD.LKeyFields,'') + ''','''+ ISNULL(OD.LLKeyFields, '') + ''',''' + ISNULL(OD.LResultField,'') + ''','''\n            + ISNULL(OD.LWhereText, '') + ''',''' + ISNULL(OD.LOrderText, '') + ''',''' + ISNULL(OD.LDetailDataSet, '') + ''', ' + CONVERT(VARCHAR(100), ISNULL(ROD.ITReadOnly,0)) + ', '\n            + CONVERT(VARCHAR(100), ISNULL(ROD.ITVisible,0))+ ', ''' + ISNULL(ROD.ITDefValue, '') + ''', ' + ISNULL('''' + G.ItemGroupName + '''', 'NULL')+ ', ' +  \n            + CONVERT(VARCHAR(100), ROM.ITEdit)+ ', '+ CONVERT(VARCHAR(100), ROM.ITInsert)+ ', '+ CONVERT(VARCHAR(100), ROM.ITDelete)+ ', '+ CONVERT(VARCHAR(100), ROM.ITReadOnly) + ')' \n    From    IT15_ObjectsD OD \n            Inner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n            LEFT OUTER JOIN IT15_RolObjectsM ROM On ROM.ITObjectID = OM.ITObjectID And ROM.RolID = 1 /* Güncel Rolünün Yetkileri alınır */\n            LEFT OUTER JOIN IT15_RolObjectsD ROD On ROD.RolObjectMID = ROM.RolObjectMID And ROD.ITObjectDID = OD.ITObjectDID\n            LEFT OUTER JOIN dbo.IT15_ObjectsItemGroup G ON G.ITObjectItemGroupID = OD.ITObjectItemGroupID\n    Where    OM.ITObjectName in (Select O.ITObjectName From @Objects O)\n\n \n\n \n\n    /* 2.X */\n    Print '\n\n    Declare @name Varchar(100)\n    Declare c Cursor Local For\n        Select Distinct ITObjectName From #Alanlar\n    Open c\n    Fetch Next From c Into @name\n    While @@FETCH_STATUS = 0 Begin\n\n        Exec SP15_AlanYenile @name\n\n \n\n        Fetch Next From c Into @name\n    End\n    Close c\n    Deallocate c\n\n \n\n    '\n\n \n\nPRINT '\n    Insert  IT15_ObjectsItemGroup (ITObjectID, ItemGroupType, ItemGroupName)\n    Select  Distinct OM.ITObjectID, 1, A.ITObjectItemGroupName\n    From    #Alanlar A\n            Inner Join IT15_ObjectsM OM On OM.ITObjectName = A.ITobjectName Collate Database_Default\n    Where   ISNULL( A.ITObjectItemGroupName, '''') <> ''''\n            And not exists(select * from IT15_ObjectsItemGroup T Where T.ITObjectID = OM.ITObjectID And T.ItemGroupName = A.ITObjectItemGroupName Collate Database_Default And T.ItemGroupType = 1 )\n'\n\n \n\n \n\n    /*2.B.1 Alanlar aktarılır - var olanlar güncellenir (yeni normal kolon hiçbir zaman eklenmez.) */\n    Print '\n    Declare @Adet int\n\n \n\n    Update    OD Set \n            FieldCaption = A.FieldCaption, \n            ShowSiraNo = A.ShowSiraNo, \n            CaptionSize = A.CaptionSize, \n            Type = A.Type,\n            NotInGrid = A.NotInGrid,\n            ITRequired = A.ITRequired,\n            LField = A.LField, \n            LDataSet = A.LDataSet, \n            LKeyFields = A.LKeyFields, \n            LLKeyFields = A.LLKeyFields, \n            LResultField = A.LResultField, \n            LWhereText = A.LWhereText, \n            LOrderText = A.LOrderText, \n            LDetailDataSet = A.LDetailDataSet,\n            ITObjectItemGroupID = G.ITObjectItemGroupID\n    From    IT15_ObjectsD OD \n            Inner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n            Inner Join #Alanlar A On OD.FieldName = A.FieldName COLLATE DATABASE_DEFAULT  And A.ITObjectName = OM.ITObjectName COLLATE DATABASE_DEFAULT \n            Left Join IT15_ObjectsItemGroup G ON G.ITObjectID = OM.ITObjectID And G.ItemGroupName = A.ITObjectItemGroupName Collate Database_Default And G.ItemGroupType = 1\n\n \n\n    Set @Adet = @@ROWCOUNT\n\n \n\n    If @Adet = 0 Raiserror(''Hiç Güncelleme yapılmadı. Muhtemelen bir yanlışlık var.'',16,1)\n    Else Print Convert(varchar(10), @Adet) +  '' adet satır güncellendi.''\n\n \n\n    '\n\n \n\n \n\n    /*    2.B.2 Alanlar aktarılır - LOOK-UP kolonlar eklenir, yetkisi verilir. */\n    Print '\n    Insert IT15_ObjectsD (ITObjectID, FieldName, FieldCaption, ShowSiraNo, CaptionSize, Type, NotInGrid, ITRequired, LField, LDataSet, LKeyFields, LLKeyFields, LResultField,\n           LWhereText, LOrderText, LDetailDataSet, FieldType)\n\n \n\n    SELECT    OM.ITObjectID, A.FieldName, A.FieldCaption, A.ShowSiraNo, A.CaptionSize, A.Type, A.NotInGrid, A.ITRequired, A.LField, A.LDataSet, A.LKeyFields,\n            A.LLKeyFields, A.LResultField, A.LWhereText, A.LOrderText, A.LDetailDataSet, ''varchar''\n    From    #Alanlar A\n            INNER JOIN IT15_ObjectsM OM On OM.ITObjectName = A.ITObjectName Collate Database_Default\n\n \n\n    Where    ISNULL(A.LDataSet,'''') <> ''''\n            And Not Exists(\n                SELECT * FROM IT15_ObjectsD OD Where OD.ITObjectID = OM.ITObjectID And OD.LDataSet = A.LDataSet Collate Database_Default \n                And OD.LKeyFields = A.LKeyFields Collate Database_Default And OD.LLKeyFields = A.LLKeyFields Collate Database_Default And OD.LResultField = A.LResultField Collate Database_Default\n            )\n\n \n\n    Set @Adet = @@ROWCOUNT\n\n \n\n    If @Adet > 0 Begin    \n        Print ''     '' + convert(varchar(10), @Adet) + '' adet yeni lookup kolon yaratıldı. Tövbe.. oluştuldu.''\n\n \n\n        /*  Eğer yeni kolon eklendiyse yetkisi de verilir. */\n        Insert  IT15_RolObjectsD(RolObjectMID, ITObjectDID, ITReadOnly, ITVisible, ITDefValue)\n        Select  ROM.RolObjectMID, OD.ITObjectDID, A.ITReadOnly, A.ITVisible, A.ITDefValue\n        From    IT15_ObjectsD OD\n                Inner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n                Inner Join #Alanlar A On A.ITObjectName = OM.ITObjectName Collate Database_Default And A.FieldName = OD.FieldName Collate Database_Default\n                Inner Join IT15_RolObjectsM ROM On ROM.ITObjectID = OM.ITObjectID And  ROM.RolID = 1\n        Where   Not Exists (Select  * From  IT15_RolObjectsD ROD Where  ROD.RolObjectMID = ROM.RolObjectMID And ROD.ITObjectDID = OD.ITObjectDID)\n\n        Set @Adet = @@ROWCOUNT\n\n \n\n        Print ''     '' + Convert(varchar(10), @Adet) + '' adet yeni lookup için yetki verildi.''\n\n \n\n    End\n    '\n\n \n\n    /* 2.B.3 Tüm kolon yetkileri güncellenir. (sadece güncel rolü için) */\n\n \n\n    Print '\n\n    ;With TMP AS (Select Distinct ITObjectName, ROMITEdit, ROMITInsert, ROMITDelete, ROMITReadOnly From #Alanlar)\n    Update  ROM\n    Set     ITEdit = ROMITEdit, ITInsert = ROMITInsert, ITDelete = ROMITDelete, ITReadOnly = ROMITReadOnly\n    From    IT15_RolObjectsM ROM \n            Inner Join IT15_ObjectsM OM On OM.ITObjectID = ROM.ITObjectID\n            Inner Join TMP T On T.ITObjectName = OM.ITObjectName COLLATE DATABASE_DEFAULT\n    Where    ROM.RolID = 1 /* Sadece GUNCEL */\n\n    Set @Adet = @@ROWCOUNT\n\n \n\n    If @Adet = 0 Raiserror(''Rol Yetkilerde hiç güncelleme yapılmadı. iki sebebi olabilir : Nesne yok veya nesnenin GUNCEL e yetkisi yok....'',16,1)\n    Else Begin \n        Print Convert(varchar(10), @Adet) + '' adet nesne için GÜNCEL rolü yetkisi güncellendi.''\n\n        Update  ROD\n        Set     ROD.ITReadOnly = A.ITReadOnly, ROD.ITVisible = A.ITVisible, ROD.ITDefValue = A.ITDefValue\n        From    IT15_ObjectsD OD\n                Inner Join IT15_RolObjectsD ROD On OD.ITObjectDID = ROD.ITObjectDID\n                Inner Join IT15_RolObjectsM ROM On ROD.RolObjectMID = ROM.RolObjectMID And ROM.RolID = 1 /* Sadece GUNCEL */\n                Inner Join IT15_ObjectsM OM On OM.ITObjectID = OD.ITObjectID\n                Inner Join #Alanlar A On OD.FieldName = A.FieldName COLLATE DATABASE_DEFAULT  And A.ITObjectName = OM.ITObjectName COLLATE DATABASE_DEFAULT\n\n \n\n \n\n        Set @Adet = @@ROWCOUNT\n\n \n\n        If @Adet = 0 Raiserror(''Kolon yetkilerde hiç güncelleme yapılmadı. Bir şeyler yolunda gitmiyor...'',16,1)\n        Else Print Convert(varchar(10), @Adet) + '' adet kolon yetkisi güncellendi. (sadece GÜNCEL rolü için)''\n\n \n\n        \n    End\n    '\nEnd\n\n \n\n \n\nIf @VeriIslemleriniAktar = 1 Begin\n    /* 3.A Veri işlemleri kaydedilir. */\n    Select\n    'Insert #VeriIslemleri (ITobjectName, SiraNo, VeriIslemAdi, SPITObjectName, DSITObjectName, DSITObjectID2Name, SFilterFieldName, DFilterFieldName, IsOnay, IsBeginGroup, SPITObjectIDWhereText, DSITWhereText, DS2ITWhereText, ITShortCutName, AnalizDataName, ITObjectItemGroupName, IsDSRequery, ShowInTab, IsToolbarButton)' + CHAR(13) +\n            'Values( ''' + OM.ITobjectName + ''', '+ CONVERT(VARCHAR(100), ISNULL(SiraNo, 0)) + ',''' + ISNULL(VeriIslemAdi, '') + ''', ''' + ISNULL(SPOM.ITObjectName, '') + ''', ''' + ISNULL(DSOM.ITObjectName, '')+ ''', '''\n            + ISNULL(DSOM2.ITObjectName, '') + ''', ''' + ISNULL(SFilterFieldName, '') + ''', ''' + ISNULL(DFilterFieldName, '') + ''', ', + CONVERT(VARCHAR(100), ISNULL(IsOnay,0)) + ', '+ CONVERT(VARCHAR(100), ISNULL(IsBeginGroup,0)) + ', '''\n            + ISNULL(SPITObjectIDWhereText, '') + ''', '''+ ISNULL(DSITWhereText, '') + ''', '''+ ISNULL(DS2ITWhereText, '') + ''', '''\n            + ISNULL(ISC.ITShortcut, '') + ''', ''' + ISNULL(ADM.AnalizAdi,'') + ''', '+ ISNULL(''''+G.ItemGroupName+'''', 'NULL') + ', '+ CONVERT(VARCHAR(100), ISNULL(IsDSRequery, 0)) + ', '\n            + CONVERT(VARCHAR(100), ISNULL(ShowInTab,0)) + ', ' + CONVERT(VARCHAR(100), ISNULL(IsToolbarButton,0)) + ')'\n    From    IT15_ObjectsVeriIslemleri VI\n            Left Outer Join IT15_ObjectsM OM On    OM.ITObjectID = VI.ITobjectID\n            Left Outer Join IT15_ObjectsM SPOM On SPOM.ITObjectID = VI.SPITObjectID\n            Left Outer Join IT15_ObjectsM DSOM On DSOM.ITObjectID = VI.DSITObjectID\n            Left Outer Join IT15_ObjectsM DSOM2 On DSOM2.ITObjectID = VI.DSITObjectID2\n            Left Outer Join IT15_ITShortCuts ISC On ISC.ITShortcutID = VI.ITShortCutID\n            Left Outer Join IT15_AnalizDataM ADM On ADM.AnalizDataID = VI.AnalizDataID\n            Left Outer Join IT15_ObjectsItemGroup G On G.ITObjectItemGroupID = VI.ITObjectItemGroupID\n    Where    OM.ITObjectName in (Select O.ITObjectName From @Objects O)\n\n \n\n    \n\n \n\n    /* 3.B Veri işlemleri aktarılır */\n    Print '\n    Insert  IT15_ObjectsItemGroup (ITObjectID, ItemGroupType, ItemGroupName)\n    Select  Distinct OM.ITObjectID, 2, VI.ITObjectItemGroupName\n    From    #VeriIslemleri VI\n            Inner Join IT15_ObjectsM OM On OM.ITObjectName = VI.ITobjectName Collate Database_Default\n    Where   ISNULL(VI.ITObjectItemGroupName, '''') <> ''''\n            And not exists(select * from IT15_ObjectsItemGroup T Where T.ITObjectID = OM.ITObjectID And T.ItemGroupName = VI.ITObjectItemGroupName Collate Database_Default And T.ItemGroupType = 2 )\n\n \n\n    Insert  IT15_ObjectsVeriIslemleri (ITObjectID, SiraNo, VeriIslemAdi, SPITObjectID, DSITObjectID, DSITObjectID2, SFilterFieldName, DFilterFieldName, IsOnay, IsBeginGroup, SPITObjectIDWhereText, DSITWhereText, DS2ITWhereText, ITShortCutID, AnalizDataID, ITObjectItemGroupID, IsDSRequery, ShowInTab, IsToolbarButton)\n    Select  OM.ITObjectID, VI.SiraNo, VI.VeriIslemAdi, SPOM.ITObjectID, DSOM.ITObjectID, DSOM2.ITObjectID, VI.SFilterFieldName, VI.DFilterFieldName, VI.IsOnay, VI.IsBeginGroup, VI.SPITObjectIDWhereText, VI.DSITWhereText, VI.DS2ITWhereText, ISC.ITShortcutID, ADM.AnalizDataID, G.ITObjectItemGroupID, VI.IsDSRequery, VI.ShowInTab, VI.IsToolbarButton\n    From    #VeriIslemleri VI\n            Left Outer Join IT15_ObjectsM OM On OM.ITObjectName = VI.ITobjectName Collate Database_Default\n            Left Outer Join IT15_ObjectsM SPOM On SPOM.ITObjectName = VI.SPITObjectName Collate Database_Default\n            Left Outer Join IT15_ObjectsM DSOM On DSOM.ITObjectName = VI.DSITObjectName Collate Database_Default\n            Left Outer Join IT15_ObjectsM DSOM2 On DSOM2.ITObjectName = VI.DSITObjectID2Name Collate Database_Default\n            Left Outer Join IT15_ITShortCuts ISC On ISC.ITShortcut = VI.ITShortCutName Collate Database_Default\n            Left Outer Join IT15_AnalizDataM ADM On ADM.AnalizAdi = VI.AnalizDataName Collate Database_Default\n            Left Outer Join IT15_ObjectsItemGroup G On G.ITObjectID = OM.ITObjectID And G.ItemGroupName = VI.ITObjectItemGroupName Collate Database_Default\n    Where Not Exists(Select * From IT15_ObjectsVeriIslemleri OVI Where OVI.ITObjectID = OM.ITObjectID And OVI.VeriIslemAdi = VI.VeriIslemAdi Collate Database_Default)\n            And (\n                Not(ISNULL(VI.SPITObjectName,'''') <> '''' And SPOM.ITObjectID Is Null)\n                And\n                Not(ISNULL(VI.DSITObjectName,'''') <> '''' And DSOM.ITObjectID Is Null )\n                And\n                Not(ISNULL(VI.DSITObjectID2Name,'''') <> '''' And DSOM2.ITObjectID Is Null )\n            )\n\n \n\n \n\n    Set @Adet = @@ROWCOUNT\n\n \n\n \n\n    If @Adet = 0 Raiserror(''Hiç veri işlemi eklenmedi. '',16,1)\n    Else Begin\n        Declare @ToplamAdet int = (Select COUNT(*) From #VeriIslemleri VI)\n        Print Convert(varchar(10), @Adet) + '' adet veri işlemi eklendi. Toplam veri işlem adedi : '' + Convert(varchar(10),  @ToplamAdet ) \n    End\n\n \n\n    Declare @M varchar(1000)\n    Select    @M = ISNULL(@M + '','', '''') +  H.N\n    From    #VeriIslemleri V Cross Apply (Select V.SPITObjectName As N Union Select V.DSITObjectName Union Select V.DSITObjectID2Name ) H\n    Where Not Exists(Select * From IT15_ObjectsM OM Where OM.ITObjectName = H.N Collate Database_Default) And  ISNULL(H.N,'''') <> ''''\n    If @M Is Not Null Raiserror(''Şu nesneler olmadığı için veri işlemleri eklenemedi. '',16,1, @M)\n\n \n\n \n\n    '\nEnd"
}